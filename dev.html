<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Master (Dev)</title>
    <style>
        :root { --cor-fundo: #0d1117; --cor-card: #161b22; --azul: #58a6ff; --verde: #238636; --vermelho: #da3633; }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--cor-fundo); color: #c9d1d9; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        .container { background: var(--cor-card); padding: 30px; border-radius: 10px; width: 100%; max-width: 600px; margin-bottom: 20px; border: 1px solid #30363d; }
        h2 { margin-top: 0; color: var(--azul); text-align: center; }
        
        label { display: block; margin-top: 15px; color: #8b949e; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; background: #0d1117; border: 1px solid #30363d; color: white; border-radius: 6px; }
        input:focus { border-color: var(--azul); outline: none; }
        
        /* ESTILO DO UPLOAD */
        .upload-box { border: 2px dashed #30363d; padding: 20px; text-align: center; margin-top: 5px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .upload-box:hover { border-color: var(--azul); background: rgba(88, 166, 255, 0.1); }
        .preview-img { max-width: 100%; height: auto; margin-top: 10px; border-radius: 5px; display: none; border: 1px solid #30363d; }
        
        button { width: 100%; padding: 15px; margin-top: 25px; border: none; cursor: pointer; font-weight: bold; border-radius: 6px; transition: 0.2s; }
        .btn-criar { background: var(--verde); color: white; }
        .btn-atualizar { background: var(--azul); color: white; }
        button:hover { opacity: 0.9; }

        .link-box { background: #0d1117; padding: 10px; margin-top: 5px; color: var(--azul); word-break: break-all; cursor: pointer; border-radius: 4px; font-family: monospace; font-size: 0.85rem; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #30363d; width: 100%; max-width: 600px; }
        .tab-btn { background: none; border: none; color: #8b949e; padding: 10px; cursor: pointer; font-size: 1rem; flex: 1; }
        .tab-btn.ativo { color: white; border-bottom: 2px solid var(--azul); }

        .grid-lojas { display: grid; gap: 15px; margin-top: 20px; }
        .card-loja { background: #0d1117; border: 1px solid #30363d; padding: 15px; border-radius: 8px; position: relative; transition: 0.2s; }
        .card-loja:hover { border-color: var(--azul); transform: translateY(-2px); }
        .card-loja h3 { margin: 0 0 5px 0; font-size: 1.1rem; color: white; }
        
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; position: absolute; top: 15px; right: 15px; }
        .badge.ativa { background: rgba(35, 134, 54, 0.2); color: var(--verde); border: 1px solid var(--verde); }
        .badge.bloq { background: rgba(218, 54, 51, 0.2); color: var(--vermelho); border: 1px solid var(--vermelho); }
        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-mini { padding: 8px; margin: 0; font-size: 0.8rem; background: #21262d; border: 1px solid #30363d; color: #c9d1d9; }
    </style>
</head>
<body>

    <div class="tabs">
        <button id="tab-lista" class="tab-btn ativo" onclick="mudarAba('lista')">üìã Todas as Lojas</button>
        <button id="tab-criar" class="tab-btn" onclick="mudarAba('criar')">‚ûï Nova Loja</button>
        <button id="tab-editar" class="tab-btn" onclick="mudarAba('editar')">‚úèÔ∏è Gerenciar</button>
    </div>

    <div id="aba-lista" class="container">
        <h2>Minhas Barbearias</h2>
        <button onclick="carregarTodasLojas()" style="background:#21262d; margin-top:0; padding:10px;">üîÑ Atualizar Lista</button>
        <div id="lista-lojas-container" class="grid-lojas"><p style="text-align:center; color:#666;">Carregando...</p></div>
    </div>

    <div id="aba-criar" class="container" style="display:none;">
        <h2>üè≠ F√°brica de Lojas</h2>
        <label>Nome da Barbearia</label> <input type="text" id="nome-loja" placeholder="Ex: Barbearia do Z√©">
        <label>ID (Slug)</label> <input type="text" id="id-loja" placeholder="ze_barber">
        
        <label>Foto de Fundo</label>
        <div class="upload-box" onclick="document.getElementById('file-criar').click()">
            üì∑ Clique para escolher a foto
        </div>
        <input type="file" id="file-criar" accept="image/*" style="display:none" onchange="processarImagem(this, 'preview-criar', 'base64-criar')">
        <img id="preview-criar" class="preview-img">
        <input type="hidden" id="base64-criar"> <button class="btn-criar" onclick="criarNovaLoja()">CRIAR LOJA</button>
        <div id="res-criar" style="display:none; margin-top:20px; padding:10px; border:1px solid var(--verde);">
            <p style="color:var(--verde)">Loja Criada! Link:</p>
            <div class="link-box" onclick="copiar(this)" id="link-app">...</div>
        </div>
    </div>

    <div id="aba-editar" class="container" style="display:none;">
        <h2>üëÆ‚Äç‚ôÇÔ∏è Controle de Acesso</h2>
        <label>ID da Loja</label> <input type="text" id="edit-id" placeholder="Ex: ze_barber">
        <button onclick="buscarLoja()" style="margin-top:10px; background:#333; color:white; padding:8px;">üîç Buscar</button>
        
        <div id="form-editar" style="display:none; border-top: 1px solid #333; margin-top:20px; padding-top:10px;">
            <label>Nome</label> <input type="text" id="edit-nome">
            
            <label>Foto de Fundo (Upload)</label>
            <div class="upload-box" onclick="document.getElementById('file-edit').click()">
                üì∑ Trocar Foto
            </div>
            <input type="file" id="file-edit" accept="image/*" style="display:none" onchange="processarImagem(this, 'preview-edit', 'base64-edit')">
            <img id="preview-edit" class="preview-img">
            <input type="hidden" id="base64-edit"> <label style="color:var(--azul);">üîë Senha Painel</label> <input type="text" id="edit-senha">
            <label style="color:var(--azul); font-weight:bold;">Status</label>
            <select id="edit-status">
                <option value="true">‚úÖ ATIVA</option>
                <option value="false">‚õî BLOQUEADA</option>
            </select>

            <button class="btn-atualizar" onclick="salvarEdicao()">SALVAR ALTERA√á√ïES</button>
        </div>
    </div>

    <script type="module">
        import { db } from "./js/config.js";
        import { doc, setDoc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Senha Mestre
        const SENHA_DEV = "mestre123";
        if(sessionStorage.getItem('dev_logado') !== 'sim') {
            const pass = prompt("Senha do Mestre:");
            if(pass === SENHA_DEV) sessionStorage.setItem('dev_logado', 'sim');
            else { document.body.innerHTML = "<h1>Bloqueado</h1>"; throw new Error("Stop"); }
        }

        // --- SISTEMA DE UPLOAD (COMPRESS√ÉO DE IMAGEM) ---
        window.processarImagem = function(input, idPreview, idHidden) {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Cria uma imagem para redimensionar
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Reduz para no m√°ximo 800px de largura (para n√£o pesar o banco)
                        const maxWidth = 800;
                        const scaleSize = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleSize;
                        
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Converte para JPG qualidade 60%
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        
                        // Mostra preview e salva no input escondido
                        const preview = document.getElementById(idPreview);
                        preview.src = dataUrl;
                        preview.style.display = 'block';
                        document.getElementById(idHidden).value = dataUrl;
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        // --- NAVEGA√á√ÉO SEGURA (SEM ERRO TARGET) ---
        window.mudarAba = function(aba) {
            document.querySelectorAll('.container').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('ativo'));
            
            const abaEl = document.getElementById(`aba-${aba}`);
            if(abaEl) abaEl.style.display = 'block';
            
            const btnEl = document.getElementById(`tab-${aba}`);
            if(btnEl) btnEl.classList.add('ativo');

            if(aba === 'lista') carregarTodasLojas();
        }

        // --- CRUD ---
        window.carregarTodasLojas = async function() {
            const container = document.getElementById('lista-lojas-container');
            container.innerHTML = '<p style="text-align:center">Buscando...</p>';
            try {
                const snapshot = await getDocs(collection(db, "lojas"));
                let html = "";
                snapshot.forEach((doc) => {
                    const d = doc.data();
                    const status = d.ativa !== false ? 'ATIVA' : 'BLOQUEADA';
                    const cor = d.ativa !== false ? 'ativa' : 'bloq';
                    html += `
                        <div class="card-loja">
                            <span class="badge ${cor}">${status}</span>
                            <h3>${d.nome}</h3>
                            <p>ID: ${doc.id}</p>
                            <div class="actions">
                                <button class="btn-mini" onclick="editarDireto('${doc.id}')">‚öôÔ∏è Editar</button>
                                <a href="index.html?loja=${doc.id}" target="_blank" class="btn-mini" style="text-decoration:none">‚ÜóÔ∏è Abrir</a>
                            </div>
                        </div>`;
                });
                container.innerHTML = html || '<p align="center">Nenhuma loja.</p>';
            } catch (e) { container.innerHTML = `<p style="color:red">${e.message}</p>`; }
        }
        carregarTodasLojas();

        document.getElementById('nome-loja').addEventListener('input', (e) => {
            document.getElementById('id-loja').value = e.target.value.toLowerCase().replace(/ /g, '_').replace(/[^\w-]+/g, '');
        });

        window.criarNovaLoja = async function() {
            const nome = document.getElementById('nome-loja').value;
            const id = document.getElementById('id-loja').value;
            const foto = document.getElementById('base64-criar').value; // Pega a foto processada

            if(!nome || !id) return alert("Preencha os campos!");
            
            try {
                const docRef = doc(db, "lojas", id);
                if((await getDoc(docRef)).exists()) return alert("ID j√° existe");
                
                await setDoc(docRef, {
                    nome, senhaAdmin: "admin123", fotoFundo: foto, ativa: true,
                    horarioInicio: 9, horarioFim: 19, intervaloMinutos: 45,
                    servicos: [{ id: 0, nome: "Corte", preco: "R$ 35,00" }]
                });
                
                document.getElementById('link-app').innerText = `${location.origin}/index.html?loja=${id}`;
                document.getElementById('res-criar').style.display = 'block';
                carregarTodasLojas();
            } catch(e) { alert("Erro: " + e.message); }
        }

        window.editarDireto = function(id) {
            mudarAba('editar');
            document.getElementById('edit-id').value = id;
            buscarLoja();
        }

        window.buscarLoja = async function() {
            const id = document.getElementById('edit-id').value;
            if(!id) return alert("Digite ID");
            const snap = await getDoc(doc(db, "lojas", id));
            if(!snap.exists()) return alert("N√£o achei");
            
            const d = snap.data();
            document.getElementById('edit-nome').value = d.nome;
            document.getElementById('edit-senha').value = d.senhaAdmin || "";
            document.getElementById('edit-status').value = d.ativa === false ? "false" : "true";
            
            // Carrega foto existente no input hidden e na preview
            if(d.fotoFundo && d.fotoFundo.startsWith('data:image')) {
                document.getElementById('preview-edit').src = d.fotoFundo;
                document.getElementById('preview-edit').style.display = 'block';
                document.getElementById('base64-edit').value = d.fotoFundo;
            } else {
                document.getElementById('preview-edit').style.display = 'none';
                document.getElementById('base64-edit').value = "";
            }
            
            document.getElementById('form-editar').style.display = 'block';
        }

        window.salvarEdicao = async function() {
            const id = document.getElementById('edit-id').value;
            const nome = document.getElementById('edit-nome').value;
            const senha = document.getElementById('edit-senha').value;
            const status = document.getElementById('edit-status').value === "true";
            const foto = document.getElementById('base64-edit').value; // Pega a foto nova

            try {
                await updateDoc(doc(db, "lojas", id), { nome, senhaAdmin: senha, ativa: status, fotoFundo: foto });
                alert("Salvo!");
                mudarAba('lista');
            } catch(e) { alert("Erro: " + e.message); }
        }
        
        window.copiar = (el) => { navigator.clipboard.writeText(el.innerText); alert("Copiado!"); }
    </script>
</body>
</html>