<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento</title>
    <style>
        :root { --cor-primaria: #D4AF37; --cor-fundo: #1a1a1a; --cor-card: #2c2c2c; --cor-texto: #ffffff; --botao-sucesso: #28a745; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background-color: var(--cor-fundo); color: var(--cor-texto); padding-bottom: 80px; }
        
        header { text-align: center; padding: 20px; background: var(--cor-card); border-bottom: 2px solid var(--cor-primaria); position: sticky; top: 0; z-index: 100; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .section-title { margin: 20px 0 10px; font-size: 1.1rem; color: #b0b0b0; border-left: 4px solid var(--cor-primaria); padding-left: 10px; }
        
        /* Cards */
        .servico-card { background: var(--cor-card); padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
        .servico-card.selecionado { border-color: var(--cor-primaria); background-color: #333; }
        
        /* Inputs e Bot√µes */
        input[type="date"] { width: 100%; padding: 15px; background: var(--cor-card); border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 20px; }
        .grade-horarios { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .horario-btn { background: var(--cor-card); border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; font-size: 0.9rem; }
        .horario-btn.selecionado { background: var(--cor-primaria); color: var(--cor-fundo); font-weight: bold; }
        .horario-btn.ocupado { background: #333; color: #555; text-decoration: line-through; }

        .fab-container { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; background: #1a1a1a; border-top: 1px solid #333; display: flex; justify-content: center; z-index: 99; }
        .btn-agendar { background: var(--botao-sucesso); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; width: 100%; max-width: 500px; opacity: 0.5; pointer-events: none; }
        .btn-agendar.ativo { opacity: 1; pointer-events: all; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: var(--cor-card); padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; }
        .btn-confirmar { background: var(--cor-primaria); color: black; font-weight: bold; padding: 12px; width: 100%; border: none; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>

    <header><h1 id="titulo-app">Carregando...</h1></header>

    <div class="container" id="conteudo-principal" style="opacity: 0.3; pointer-events: none;">
        <div class="section-title">1. Escolha o Servi√ßo</div>
        <div id="lista-servicos"></div>

        <div class="section-title">2. Escolha a Data</div>
        <input type="date" id="data-agendamento">

        <div class="section-title">3. Escolha o Hor√°rio</div>
        <div class="grade-horarios" id="lista-horarios"><p style="grid-column: span 4; text-align: center; color: #555;">Selecione data e servi√ßo</p></div>
    
        <div style="margin-top:40px; text-align:center;">
            <a href="admin.html" style="color:#444; text-decoration:none; font-size:0.8rem; border:1px solid #333; padding:5px 10px; border-radius:15px;">üîí √Årea do Parceiro</a>
        </div>
    </div>

    <div class="fab-container"><button id="btn-finalizar" class="btn-agendar">AGENDAR</button></div>

    <div class="modal" id="modal-cadastro">
        <div class="modal-content">
            <h2 style="color:var(--cor-primaria)">Confirmar</h2>
            <input type="text" id="cliente-nome" placeholder="Seu Nome">
            <input type="tel" id="cliente-zap" placeholder="Seu WhatsApp">
            <button class="btn-confirmar" onclick="finalizarAgendamento()">CONFIRMAR AGENDAMENTO</button>
            <button onclick="document.getElementById('modal-cadastro').style.display='none'" style="background:transparent; border:none; color:#777; margin-top:15px;">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        /* --- CONFIGURA√á√ÉO FIREBASE (COLE SUAS CHAVES AQUI) --- */
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJETO",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ID_LOJA = "barbearia_central_01";
        
        let LOJA_CONFIG = {}; 
        let selecao = { servico: null, data: null, horario: null };

        // 1. INICIALIZA√á√ÉO INTELIGENTE (Busca config no banco)
        async function iniciarApp() {
            const docRef = doc(db, "lojas", ID_LOJA);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                LOJA_CONFIG = docSnap.data();
                renderizarApp();
            } else {
                alert("Erro: Configura√ß√£o da barbearia n√£o encontrada. Acesse o painel Admin para configurar.");
                document.getElementById('titulo-app').innerText = "Loja n√£o configurada";
            }
        }
        iniciarApp();

        function renderizarApp() {
            document.getElementById('titulo-app').innerText = "Barbearia Online"; // Ou LOJA_CONFIG.nome se tiver
            document.getElementById('conteudo-principal').style.opacity = "1";
            document.getElementById('conteudo-principal').style.pointerEvents = "all";

            // Renderiza Servi√ßos
            const container = document.getElementById('lista-servicos');
            container.innerHTML = '';
            LOJA_CONFIG.servicos.forEach(serv => {
                const div = document.createElement('div');
                div.className = 'servico-card';
                div.innerHTML = `<div><h3>${serv.nome}</h3><p style="color:var(--cor-primaria)">${serv.preco}</p></div><div>‚û°Ô∏è</div>`;
                div.onclick = () => {
                    document.querySelectorAll('.servico-card').forEach(e => e.classList.remove('selecionado'));
                    div.classList.add('selecionado');
                    selecao.servico = serv;
                    atualizarBotao();
                };
                container.appendChild(div);
            });
        }

        // 2. L√≥gica de Data e Hor√°rio
        const inputData = document.getElementById('data-agendamento');
        inputData.min = new Date().toISOString().split("T")[0];
        
        inputData.addEventListener('change', async (e) => {
            selecao.data = e.target.value;
            const container = document.getElementById('lista-horarios');
            container.innerHTML = '<p style="grid-column: span 4; text-align: center;">Verificando agenda...</p>';
            
            // Busca ocupados
            const q = query(collection(db, "agendamentos"), where("loja_id", "==", ID_LOJA), where("data", "==", selecao.data));
            const snapshot = await getDocs(q);
            const ocupados = [];
            snapshot.forEach(doc => ocupados.push(doc.data().horario));

            gerarGradeHorarios(ocupados);
            atualizarBotao();
        });

        function gerarGradeHorarios(ocupados) {
            const container = document.getElementById('lista-horarios');
            container.innerHTML = '';
            
            let hora = LOJA_CONFIG.horarioInicio;
            let min = 0;
            const fim = LOJA_CONFIG.horarioFim;

            while (hora < fim) {
                const horarioStr = `${hora.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`;
                
                const btn = document.createElement('button');
                btn.className = 'horario-btn';
                btn.innerText = horarioStr;

                if (ocupados.includes(horarioStr)) {
                    btn.classList.add('ocupado'); btn.disabled = true;
                } else {
                    btn.onclick = () => {
                        document.querySelectorAll('.horario-btn').forEach(e => e.classList.remove('selecionado'));
                        btn.classList.add('selecionado');
                        selecao.horario = horarioStr;
                        atualizarBotao();
                    };
                }
                container.appendChild(btn);

                min += LOJA_CONFIG.intervaloMinutos;
                if(min >= 60) { hora++; min -= 60; }
            }
        }

        function atualizarBotao() {
            const btn = document.getElementById('btn-finalizar');
            if(selecao.servico && selecao.data && selecao.horario) {
                btn.classList.add('ativo'); btn.innerText = `AGENDAR (${selecao.horario})`;
            } else {
                btn.classList.remove('ativo'); btn.innerText = "AGENDAR";
            }
        }

        document.getElementById('btn-finalizar').addEventListener('click', () => {
            if(document.getElementById('btn-finalizar').classList.contains('ativo')) {
                document.getElementById('modal-cadastro').style.display = 'flex';
            }
        });

        window.finalizarAgendamento = async function() {
            const nome = document.getElementById('cliente-nome').value;
            const zap = document.getElementById('cliente-zap').value;
            
            if(!nome || !zap) return alert("Preencha seus dados.");
            document.querySelector('.btn-confirmar').innerText = "Agendando...";

            try {
                await addDoc(collection(db, "agendamentos"), {
                    loja_id: ID_LOJA,
                    data: selecao.data,
                    horario: selecao.horario,
                    servico: selecao.servico.nome,
                    cliente_nome: nome,
                    cliente_zap: zap,
                    criado_em: new Date()
                });
                alert("Agendamento Confirmado!");
                location.reload();
            } catch (e) {
                alert("Erro: " + e.message);
            }
        }
    </script>
</body>
</html>