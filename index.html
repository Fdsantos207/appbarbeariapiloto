<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento</title>
    <style>
        :root { --cor-primaria: #D4AF37; --cor-fundo: #1a1a1a; --cor-card: #2c2c2c; --cor-texto: #ffffff; --botao-sucesso: #28a745; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: sans-serif; }
        body { background-color: var(--cor-fundo); color: var(--cor-texto); padding-bottom: 80px; }
        
        header { text-align: center; padding: 20px; background: var(--cor-card); border-bottom: 2px solid var(--cor-primaria); position: sticky; top: 0; z-index: 100; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .section-title { margin: 20px 0 10px; font-size: 1.1rem; color: #b0b0b0; border-left: 4px solid var(--cor-primaria); padding-left: 10px; }
        
        /* Cards */
        .servico-card { background: var(--cor-card); padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
        .servico-card.selecionado { border-color: var(--cor-primaria); background-color: #333; }
        
        /* Inputs e Bot√µes */
        input[type="date"] { width: 100%; padding: 15px; background: var(--cor-card); border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 20px; }
        .grade-horarios { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .horario-btn { background: var(--cor-card); border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; font-size: 0.9rem; }
        .horario-btn.selecionado { background: var(--cor-primaria); color: var(--cor-fundo); font-weight: bold; }
        .horario-btn.ocupado { background: #333; color: #555; text-decoration: line-through; }

        .fab-container { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px; background: #1a1a1a; border-top: 1px solid #333; display: flex; justify-content: center; z-index: 99; }
        .btn-agendar { background: var(--botao-sucesso); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; width: 100%; max-width: 500px; opacity: 0.5; pointer-events: none; }
        .btn-agendar.ativo { opacity: 1; pointer-events: all; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: var(--cor-card); padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; }
        .btn-confirmar { background: var(--cor-primaria); color: black; font-weight: bold; padding: 12px; width: 100%; border: none; border-radius: 5px; margin-top: 10px; }
		/* --- NOTIFICA√á√ïES TOAST --- */
.toast {
    visibility: hidden; min-width: 250px; margin-left: -125px;
    background-color: #333; color: #fff; text-align: center; border-radius: 50px;
    padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 80px;
    font-size: 17px; box-shadow: 0px 4px 15px rgba(0,0,0,0.4);
    transform: translateY(100px); transition: transform 0.3s, visibility 0.3s;
}
.toast.show { visibility: visible; transform: translateY(0); }
.toast.sucesso { background-color: #28a745; }
.toast.erro { background-color: #dc3545; }
    </style>
</head>
<body>
	<div id="toast-box" class="toast">Notifica√ß√£o</div>

    <header style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;">
        <h1 id="nome-barbearia" style="font-size: 1.2rem; margin:0;">Carregando...</h1>
        
        <button onclick="verMeusAgendamentos()" style="background: transparent; border: 1px solid #444; color: var(--cor-primaria); padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;">
            üìÖ Meus Cortes
        </button>
    </header>

    <div class="container" id="conteudo-principal" style="opacity: 0.3; pointer-events: none;">
        <div class="section-title">1. Escolha o Servi√ßo</div>
        <div id="lista-servicos"></div>

        <div class="section-title">2. Escolha a Data</div>
        <input type="date" id="data-agendamento">

        <div class="section-title">3. Escolha o Hor√°rio</div>
        <div class="grade-horarios" id="lista-horarios"><p style="grid-column: span 4; text-align: center; color: #555;">Selecione data e servi√ßo</p></div>
    
        <div style="margin-top:40px; text-align:center;">
            <a href="admin.html" style="color:#444; text-decoration:none; font-size:0.8rem; border:1px solid #333; padding:5px 10px; border-radius:15px;">üîí √Årea do Parceiro</a>
        </div>
    </div>

    <div class="fab-container"><button id="btn-finalizar" class="btn-agendar">AGENDAR</button></div>

    <div class="modal" id="modal-cadastro">
        <div class="modal-content">
            <h2 style="color:var(--cor-primaria)">Confirmar</h2>
            <input type="text" id="cliente-nome" placeholder="Seu Nome">
            <input type="tel" id="cliente-zap" placeholder="Seu WhatsApp">
            <button class="btn-confirmar" onclick="finalizarAgendamento()">CONFIRMAR AGENDAMENTO</button>
            <button onclick="document.getElementById('modal-cadastro').style.display='none'" style="background:transparent; border:none; color:#777; margin-top:15px;">Cancelar</button>
        </div>
		<div class="modal" id="modal-historico">
        <div class="modal-content" style="text-align: left;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                <h3 style="color:var(--cor-primaria)">Meus Agendamentos</h3>
                <button onclick="document.getElementById('modal-historico').style.display='none'" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div id="lista-historico" style="max-height: 300px; overflow-y: auto;">
                <p style="color:#777; text-align:center">Carregando...</p>
            </div>
        </div>
    </div>
    </div>

    <script type="module">
	// Fun√ß√£o para mostrar notifica√ß√£o
window.mostrarToast = function(mensagem, tipo = 'normal') {
    const x = document.getElementById("toast-box");
    x.innerText = mensagem;
    x.className = "toast show";
    if(tipo === 'sucesso') x.classList.add('sucesso');
    if(tipo === 'erro') x.classList.add('erro');
    
    // Some depois de 3 segundos
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
}
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        /* --- CONFIGURA√á√ÉO FIREBASE (COLE SUAS CHAVES AQUI) --- */
        const firebaseConfig = {
  apiKey: "AIzaSyCEAeMxXbX047DhHYyAI-r4I_4eqlGA4W0",
  authDomain: "appbarbeariapiloto.firebaseapp.com",
  projectId: "appbarbeariapiloto",
  storageBucket: "appbarbeariapiloto.firebasestorage.app",
  messagingSenderId: "132643765315",
  appId: "1:132643765315:web:60568343cecfa5720268f6"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ID_LOJA = "barbearia_central_01";
        
        let LOJA_CONFIG = {}; 
        let selecao = { servico: null, data: null, horario: null };

        // 1. INICIALIZA√á√ÉO INTELIGENTE (Busca config no banco)
        async function iniciarApp() {
            const docRef = doc(db, "lojas", ID_LOJA);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                LOJA_CONFIG = docSnap.data();
                renderizarApp();
            } else {
                alert("Erro: Configura√ß√£o da barbearia n√£o encontrada. Acesse o painel Admin para configurar.");
                document.getElementById('titulo-app').innerText = "Loja n√£o configurada";
            }
        }
        iniciarApp();

        function renderizarApp() {
            document.getElementById('titulo-app').innerText = "Barbearia Online"; // Ou LOJA_CONFIG.nome se tiver
            document.getElementById('conteudo-principal').style.opacity = "1";
            document.getElementById('conteudo-principal').style.pointerEvents = "all";

            // Renderiza Servi√ßos
            const container = document.getElementById('lista-servicos');
            container.innerHTML = '';
            LOJA_CONFIG.servicos.forEach(serv => {
                const div = document.createElement('div');
                div.className = 'servico-card';
                div.innerHTML = `<div><h3>${serv.nome}</h3><p style="color:var(--cor-primaria)">${serv.preco}</p></div><div>‚û°Ô∏è</div>`;
                div.onclick = () => {
                    document.querySelectorAll('.servico-card').forEach(e => e.classList.remove('selecionado'));
                    div.classList.add('selecionado');
                    selecao.servico = serv;
                    atualizarBotao();
                };
                container.appendChild(div);
            });
        }

        // 2. L√≥gica de Data e Hor√°rio
        const inputData = document.getElementById('data-agendamento');
        inputData.min = new Date().toISOString().split("T")[0];
        
        inputData.addEventListener('change', async (e) => {
            selecao.data = e.target.value;
            const container = document.getElementById('lista-horarios');
            container.innerHTML = '<p style="grid-column: span 4; text-align: center;">Verificando agenda...</p>';
            
            // Busca ocupados
            const q = query(collection(db, "agendamentos"), where("loja_id", "==", ID_LOJA), where("data", "==", selecao.data));
            const snapshot = await getDocs(q);
            const ocupados = [];
            snapshot.forEach(doc => ocupados.push(doc.data().horario));

            gerarGradeHorarios(ocupados);
            atualizarBotao();
        });

        function gerarGradeHorarios(ocupados) {
            const container = document.getElementById('lista-horarios');
            container.innerHTML = '';
            
            let hora = LOJA_CONFIG.horarioInicio;
            let min = 0;
            const fim = LOJA_CONFIG.horarioFim;

            while (hora < fim) {
                const horarioStr = `${hora.toString().padStart(2,'0')}:${min.toString().padStart(2,'0')}`;
                
                const btn = document.createElement('button');
                btn.className = 'horario-btn';
                btn.innerText = horarioStr;

                if (ocupados.includes(horarioStr)) {
                    btn.classList.add('ocupado');
                    // Agora o bot√£o ocupado √© clic√°vel, mas s√≥ para dar aviso
                    btn.onclick = () => mostrarToast(`O hor√°rio ${horarioStr} j√° est√° reservado.`, "erro");
                } else {
                    btn.onclick = () => {
                        document.querySelectorAll('.horario-btn').forEach(e => e.classList.remove('selecionado'));
                        btn.classList.add('selecionado');
                        selecao.horario = horarioStr;
                        atualizarBotao();
                    };
                }
                container.appendChild(btn);

                min += LOJA_CONFIG.intervaloMinutos;
                if(min >= 60) { hora++; min -= 60; }
            }
        }

        function atualizarBotao() {
            const btn = document.getElementById('btn-finalizar');
            if(selecao.servico && selecao.data && selecao.horario) {
                btn.classList.add('ativo'); btn.innerText = `AGENDAR (${selecao.horario})`;
            } else {
                btn.classList.remove('ativo'); btn.innerText = "AGENDAR";
            }
        }

        document.getElementById('btn-finalizar').addEventListener('click', () => {
            if(document.getElementById('btn-finalizar').classList.contains('ativo')) {
                document.getElementById('modal-cadastro').style.display = 'flex';
            }
        });

        // --- NOVO C√ìDIGO DE FINALIZA√á√ÉO E MEM√ìRIA ---

    // 1. Ao carregar a p√°gina, verifica se j√° tem dados salvos
    window.addEventListener('load', () => {
        const nomeSalvo = localStorage.getItem('user_nome');
        const zapSalvo = localStorage.getItem('user_zap');
        if(nomeSalvo) document.getElementById('cliente-nome').value = nomeSalvo;
        if(zapSalvo) document.getElementById('cliente-zap').value = zapSalvo;
    });

    window.finalizarAgendamento = async function() {
        const nome = document.getElementById('cliente-nome').value;
        const zap = document.getElementById('cliente-zap').value;
        
        if(!nome || !zap) {
            mostrarToast("Preencha todos os campos!", "erro"); // Usando o Toast novo
            return;
        }

        // SALVAR NA MEM√ìRIA DO CELULAR
        localStorage.setItem('user_nome', nome);
        localStorage.setItem('user_zap', zap);

        const btnConfirmar = document.querySelector('.btn-confirmar');
        btnConfirmar.innerText = "Agendando...";
        btnConfirmar.disabled = true;

        try {
            await addDoc(collection(db, "agendamentos"), {
                loja_id: ID_LOJA,
                data: selecao.data,
                horario: selecao.horario,
                servico: selecao.servico.nome,
                cliente_nome: nome,
                cliente_zap: zap,
                criado_em: new Date()
            });

            mostrarToast("Agendado com Sucesso!", "sucesso");
            
            // FECHAR MODAL E LIMPAR TUDO
            setTimeout(() => {
                document.getElementById('modal-cadastro').style.display = 'none';
                
                // --- MELHORIA 3: MANDA PRO WHATSAPP ---
                // Cria uma mensagem autom√°tica para o cliente enviar para o barbeiro (opcional)
                // Voc√™ precisaria do n√∫mero do barbeiro na config, mas por enquanto vamos s√≥ recarregar
                location.reload(); 
            }, 2000);

        } catch (e) {
            console.error(e);
            mostrarToast("Erro ao agendar via internet.", "erro");
            btnConfirmar.innerText = "TENTAR NOVAMENTE";
            btnConfirmar.disabled = false;
        }
    }
	// --- FUN√á√ÉO MEUS AGENDAMENTOS ---
    window.verMeusAgendamentos = async function() {
        const zapSalvo = localStorage.getItem('user_zap'); // Pega o zap da mem√≥ria
        
        if (!zapSalvo) {
            mostrarToast("Voc√™ ainda n√£o fez agendamentos.", "erro");
            return;
        }

        // Abre o modal
        document.getElementById('modal-historico').style.display = 'flex';
        const listaDiv = document.getElementById('lista-historico');
        listaDiv.innerHTML = '<p style="text-align:center; color:#888; margin-top:20px">Buscando sua ficha...</p>';

        try {
            // Busca no Firebase: Onde o cliente_zap for igual ao salvo
            const q = query(collection(db, "agendamentos"), 
                where("loja_id", "==", ID_LOJA),
                where("cliente_zap", "==", zapSalvo)
            );
            
            const snapshot = await getDocs(q);
            const agendamentos = [];
            
            snapshot.forEach(doc => agendamentos.push(doc.data()));

            // Ordena por data (gambiarra simples para ordenar string de data)
            agendamentos.sort((a, b) => (a.data + a.horario).localeCompare(b.data + b.horario));

            if (agendamentos.length === 0) {
                listaDiv.innerHTML = '<p style="text-align:center; margin-top:20px">Nenhum agendamento encontrado.</p>';
                return;
            }

            // Monta o HTML da lista
            let html = "";
            agendamentos.forEach(item => {
                // Formata data de 2023-10-25 para 25/10
                const dataFormatada = item.data.split('-').reverse().slice(0,2).join('/');
                
                html += `
                    <div style="background:#222; padding:12px; margin-bottom:10px; border-radius:8px; border-left: 3px solid var(--cor-primaria);">
                        <div style="display:flex; justify-content:space-between;">
                            <span style="font-weight:bold; color:#fff">${dataFormatada} √†s ${item.horario}</span>
                            <span style="color:var(--cor-primaria); font-size:0.8rem">Agendado</span>
                        </div>
                        <div style="color:#aaa; font-size:0.9rem; margin-top:5px;">${item.servico}</div>
                    </div>
                `;
            });

            listaDiv.innerHTML = html;

        } catch (e) {
            console.error(e);
            listaDiv.innerHTML = '<p style="color:red; text-align:center">Erro ao buscar hist√≥rico.</p>';
            
            // Dica de Debug: O Firebase pode pedir para criar um √≠ndice no console na primeira vez
            if(e.message.includes("requires an index")) {
                console.log("Crie o √≠ndice no link que apareceu no console!");
            }
        }
    }
    </script>
</body>
</html>